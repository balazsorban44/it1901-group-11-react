<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/components/BookingBoss/Bookings.jsx | it1901-group-11</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-band">components/Band</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Band/Concerts.jsx~Concerts.html">Concerts</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Band/Reviews.jsx~AddReview.html">AddReview</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Band/TechnicalRequirements.jsx~TechnicalRequirements.html">TechnicalRequirements</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Band/index.js~Band.html">Band</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Reviews">Reviews</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-bookingboss">components/BookingBoss</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/BookingBoss/Bookings.jsx~Bookings.html">Bookings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/BookingBoss/index.js~BookingBoss.html">BookingBoss</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Booking">Booking</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-bookingmanager">components/BookingManager</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/BookingManager/BookingStepper.jsx~VerticalLinearStepper.html">VerticalLinearStepper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/BookingManager/NewBooking.jsx~NewBooking.html">NewBooking</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/BookingManager/Search.jsx~Search.html">Search</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/BookingManager/index.js~BookingManager.html">BookingManager</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-login">components/Login</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Login/index.jsx~Login.html">Login</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-manager">components/Manager</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Manager/index.js~Manager.html">Manager</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-organizer">components/Organizer</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Organizer/index.js~Organizer.html">Organizer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EventInfo">EventInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ScenesList">ScenesList</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-prorganizer">components/PROrganizer</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/PROrganizer/index.js~PROrganizer.html">PROrganizer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ScenesList">ScenesList</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-servicemanager">components/ServiceManager</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/ServiceManager/index.js~ServiceManager.html">ServiceManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Scenes">Scenes</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-technician">components/Technician</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Technician/index.js~Technician.html">Technician</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Concerts">Concerts</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Icon">Icon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-InfoSnippet">InfoSnippet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Loading">Loading</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-NoResult">NoResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Rating">Rating</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Review">Review</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-capitalize">capitalize</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseDate">parseDate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseNumber">parseNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parsePrice">parsePrice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseTime">parseTime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-muiTheme">muiTheme</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-profiles">profiles</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/components/BookingBoss/Bookings.jsx</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import React, { Component } from &apos;react&apos;

import {Tabs, Tab} from &apos;material-ui/Tabs&apos;
import RaisedButton from &apos;material-ui/RaisedButton&apos;
import firebase from &apos;firebase&apos;
import {parseDate, parseTime, parsePrice, Loading} from &apos;../../utils&apos;

import Moment from &apos;moment&apos;
import { extendMoment } from &apos;moment-range&apos;
const moment = extendMoment(Moment)

export default class Bookings extends Component {

  render() {
    const {unhandledCounter, unhandledBookings, acceptedCounter, acceptedBookings, rejectedCounter, rejectedBookings} = this.props
    return (
      &lt;Tabs&gt;
        &lt;Tab label={`New(${unhandledCounter})`}&gt;
          {unhandledCounter !== 0 ?
            &lt;BookingTab bookings={unhandledBookings}/&gt;
          :
          &lt;Loading/&gt;}
        &lt;/Tab&gt;/&gt;
        &lt;Tab label={`Accepted(${acceptedCounter})`}&gt;
          &lt;BookingTab bookings={acceptedBookings}/&gt;
        &lt;/Tab&gt;/&gt;
        &lt;Tab label={`Rejected(${rejectedCounter})`}&gt;
          &lt;BookingTab bookings={rejectedBookings} /&gt;
        &lt;/Tab&gt;/&gt;
      &lt;/Tabs&gt;
    )
  }
}



const BookingTab = ({bookings}) =&gt; {
  return (
    &lt;ul className=&quot;booking-list&quot;&gt;
      {bookings}
    &lt;/ul&gt;
  )
}

export const Booking = ({eventName, bandName, from, bandFee, bookingState, concertKey}) =&gt; {

  // Check if the booking time range does not crash with an existing concert.
  const validateBooking = (scene, concertTimeRange) =&gt; {
    const db = firebase.database()
    const sceneRef = db.ref(`scenes/${scene}`)
    let promises = []
    return new Promise((resolve, reject) =&gt; {
      sceneRef.once(&apos;value&apos;, snap =&gt; {
        const {concerts} = snap.val()
        concerts.forEach(concertKey =&gt; {
          promises.push(db.ref(`concerts/${concertKey}`).once(&apos;value&apos;).then(snap =&gt; {
            const {scene: currentScene} = snap.val()
            if (currentScene === scene) {
              const {from, to} = snap.val()
              const existingConcertTimeRange = moment.range(new Date(from), new Date(to))
              return concertTimeRange.overlaps(existingConcertTimeRange)
            }
            return false
          }))
        })
      }).then(() =&gt; {
        resolve(Promise.all(promises).then(result =&gt; result.some(e =&gt; e)))
      })
    })
  }



  const handleBooking = (concert, isAcceptedByBookingBoss) =&gt; {
    const db = firebase.database()
    const concertRef = db.ref(`concerts/${concert}`)
    concertRef.once(&quot;value&quot;).then(snap =&gt; {
      const {scene, band, from, to} = snap.val()
      const concertTimeRange = moment.range(new Date(from), new Date(to))

      validateBooking(scene, concertTimeRange)
        .then(isConcertCrash =&gt; {
          if (!isConcertCrash || !isAcceptedByBookingBoss) {
            if (isAcceptedByBookingBoss) {
              // Update band.concerts list.
              const bandConcertsRef = db.ref(`bands/${band}/concerts`)
              bandConcertsRef.once(&apos;value&apos;).then(snap =&gt; {
                const concerts = snap.val()
                concerts.push(concert)
                bandConcertsRef.set(concerts)
              })
              // Update scenes/concerts list.
              const sceneConcertsRef = db.ref(`scenes/${scene}/concerts`)
              sceneConcertsRef.once(&apos;value&apos;).then(snap =&gt; {
                const concerts = snap.val()
                concerts.push(concert)
                sceneConcertsRef.set(concerts)
              })

            }
            // Update isAcceptedByBookingBoss boolean.
            concertRef.child(&apos;isAcceptedByBookingBoss&apos;).set(isAcceptedByBookingBoss)
          } else {
            // REVIEW: Better error handling
            alert(&quot;This booking cannot be accepted, because it crashes with an existing concert. Please tell the booking manager.&quot;);
          }
      })
    })
  }

  let bookingStateAction = &lt;div&gt;
    &lt;RaisedButton className=&quot;accept-button&quot; label=&quot;Accept&quot; primary onClick={(id, isAccepted) =&gt; handleBooking(concertKey, true)}/&gt;
    &lt;RaisedButton label=&quot;Reject&quot; secondary onClick={(id, isAccepted) =&gt; handleBooking(concertKey, false)}/&gt;
  &lt;/div&gt;
  let icon = &quot;bookmark_border&quot;
  let color = &quot;&quot;
  if (bookingState === true) {
    bookingStateAction = &quot;Accepted&quot;
    icon = &quot;done&quot;
    color = &quot;green&quot;
  } else if (bookingState === false) {
    bookingStateAction = &quot;Rejected&quot;
    icon = &quot;clear&quot;
    color = &quot;red&quot;
  }
  return (
    &lt;li&gt;
      &lt;div className=&quot;mdl-card mdl-shadow--2dp&quot;&gt;
        &lt;div className=&quot;booking-body mdl-card__title mdl-card--expand&quot;&gt;
          &lt;span className=&quot;booking-bg&quot;/&gt;
          &lt;h4&gt;{bandName} &lt;br/&gt;@&lt;br/&gt;&lt;/h4&gt;
          &lt;h5&gt;
            {eventName} &lt;br/&gt;
            {parseDate(from)} - {parseTime(from)}
            &lt;br/&gt;
            {parsePrice(bandFee)}
          &lt;/h5&gt;
        &lt;/div&gt;
        &lt;div className=&quot;booking-footer mdl-card__actions mdl-card--border&quot;&gt;
          {bookingStateAction}&lt;div className=&quot;mdl-layout-spacer&quot;&gt;&lt;/div&gt;
          &lt;i className={`material-icons ${color}`}&gt;{icon}&lt;/i&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/li&gt;
  )
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
